#!/bin/bash
# =============================================================================
# MAVLink-Anywhere: Unified CLI
# =============================================================================
# Version: 2.0.3
# Author: Alireza Ghaderi
# GitHub: https://github.com/alireza787b/mavlink-anywhere
# =============================================================================
#
# This is the main entry point for mavlink-anywhere.
# Usage: mavlink-anywhere <command> [options]
#
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="2.0.3"

# Source libraries if available
if [[ -f "${SCRIPT_DIR}/lib/common.sh" ]]; then
    source "${SCRIPT_DIR}/lib/common.sh"
fi

show_help() {
    cat <<HELPEOF
MAVLink-Anywhere v${VERSION}
Stream MAVLink telemetry from your drone to anywhere in the world.

Usage: mavlink-anywhere <command> [options]

Commands:
  install       Install mavlink-router from source
  configure     Configure mavlink-router (interactive or headless)
  status        Show service status and current configuration
  start         Start the mavlink-router service
  stop          Stop the mavlink-router service
  restart       Restart the mavlink-router service
  logs          Show service logs (-f to follow)
  test          Test serial connection for MAVLink data
  uninstall     Remove mavlink-router service
  version       Show version information
  help          Show this help message

Examples:
  # Install mavlink-router
  sudo mavlink-anywhere install

  # Interactive configuration
  sudo mavlink-anywhere configure

  # Auto mode with GCS IP
  sudo mavlink-anywhere configure --auto --gcs-ip 192.168.1.100

  # Headless with UART
  sudo mavlink-anywhere configure --headless \\
      --uart /dev/ttyS0 --baud 57600 \\
      --endpoints "127.0.0.1:14540,127.0.0.1:14569,192.168.1.100:24550"

  # UDP input for SITL
  sudo mavlink-anywhere configure --headless \\
      --input-type udp --input-port 14550 \\
      --endpoints "127.0.0.1:14540,127.0.0.1:14569"

  # Check status
  mavlink-anywhere status

  # Follow logs
  mavlink-anywhere logs -f

Documentation: https://github.com/alireza787b/mavlink-anywhere
HELPEOF
}

show_version() {
    echo "mavlink-anywhere version ${VERSION}"
    if command -v mavlink-routerd &>/dev/null; then
        echo "mavlink-router: $(mavlink-routerd --version 2>&1 | head -1)"
    else
        echo "mavlink-router: not installed"
    fi
}

# Main command routing
case "${1:-help}" in
    install)
        shift
        sudo "${SCRIPT_DIR}/install_mavlink_router.sh" "$@"
        ;;
    configure|config)
        shift
        sudo "${SCRIPT_DIR}/configure_mavlink_router.sh" "$@"
        ;;
    status)
        "${SCRIPT_DIR}/mavlink-router-cli.sh" status
        ;;
    start)
        sudo systemctl start mavlink-router
        echo "Service started"
        systemctl status mavlink-router --no-pager
        ;;
    stop)
        sudo systemctl stop mavlink-router
        echo "Service stopped"
        ;;
    restart)
        sudo systemctl restart mavlink-router
        echo "Service restarted"
        systemctl status mavlink-router --no-pager
        ;;
    logs|log)
        shift
        if [[ "$1" == "-f" || "$1" == "--follow" ]]; then
            journalctl -u mavlink-router -f
        else
            lines="${1:-50}"
            journalctl -u mavlink-router -n "$lines" --no-pager
        fi
        ;;
    test)
        shift
        # Test serial connection
        UART_DEVICE="${1:-}"
        if [[ -z "$UART_DEVICE" ]]; then
            # Auto-detect
            if [[ -e /dev/serial0 ]]; then
                UART_DEVICE=$(readlink -f /dev/serial0)
            elif [[ -e /dev/ttyS0 ]]; then
                UART_DEVICE="/dev/ttyS0"
            elif [[ -e /dev/ttyUSB0 ]]; then
                UART_DEVICE="/dev/ttyUSB0"
            else
                echo "No serial device found. Specify with: mavlink-anywhere test /dev/ttyXXX"
                exit 1
            fi
        fi
        echo "Testing serial device: $UART_DEVICE"
        echo "Press Ctrl+C to stop..."
        echo ""
        timeout 10 cat "$UART_DEVICE" | xxd | head -20 || echo "No data received (10s timeout)"
        ;;
    uninstall)
        shift
        echo "Stopping service..."
        sudo systemctl stop mavlink-router 2>/dev/null || true
        sudo systemctl disable mavlink-router 2>/dev/null || true
        echo "Removing service file..."
        sudo rm -f /etc/systemd/system/mavlink-router.service
        sudo systemctl daemon-reload
        if [[ "$1" == "--remove-config" ]]; then
            echo "Removing configuration..."
            sudo rm -rf /etc/mavlink-router
            sudo rm -f /etc/default/mavlink-router
        fi
        echo "Uninstall complete"
        ;;
    version|-v|--version)
        show_version
        ;;
    help|-h|--help)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
